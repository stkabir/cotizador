---
import '../styles/global.css';
---
<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="generator" content="Astro" />
		<title>Simulador de crédito | Creditaria</title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
		/>
	</head>
	<body class="min-h-screen bg-slate-950 font-[Montserrat] text-white">
		<div class="relative flex min-h-screen flex-col overflow-hidden">
			<img
				src="https://creditaria.online/web/image/729227-bb3ca84c/simulador_fondo_simple.png"
				alt="Fondo decorativo con motivos geométricos"
				loading="lazy"
				class="absolute inset-0 h-full w-full object-cover"
			/>
			<div class="absolute inset-0 bg-slate-950/80"></div>

			<main class="relative z-10 flex flex-1 items-center justify-center px-4 py-12 sm:px-6 lg:px-12">
				<div class="flex w-full max-w-6xl flex-col items-center gap-12 lg:flex-row lg:items-start lg:justify-between">
					<section class="flex w-full max-w-xl flex-col items-center gap-8 text-center lg:items-start lg:text-left" aria-label="Creditaria branding">
						<div class="flex flex-col items-center gap-6 lg:items-start">
							<img
								src="https://creditaria.online/web/image/729228-e8ec182f/logo_horizontal_creditaria.png"
								alt="Creditaria"
								loading="lazy"
								class="w-full max-w-xs"
							/>
							<img
								src="https://creditaria.online/web/image/729229-05d477d1/texto_png_cotizador.png"
								alt="Simulador de Crédito"
								loading="lazy"
								class="w-full max-w-xs"
							/>
						</div>
						<p class="max-w-md text-sm text-white/70 sm:text-base text-center">
							Conoce en minutos la mensualidad aproximada de tu crédito y recibe asesoría personalizada de nuestros expertos.
						</p>
					</section>

					<div class="flex w-full max-w-md justify-center" aria-label="Simulador de crédito">
						<div class="cotizador flex w-full max-w-md flex-col overflow-hidden rounded-3xl border border-white/10 bg-slate-900/75 p-6 shadow-[0_32px_90px_rgba(9,17,37,0.55)] backdrop-blur-md min-h-162 max-h-162 sm:min-h-177 sm:max-h-177 sm:p-8" data-view="select">
							<section class="cotizador__stage flex flex-1 flex-col gap-6 overflow-y-auto pr-1 sm:pr-2" data-stage="select" aria-label="Selecciona el tipo de crédito">
								<div class="cotizador__heading flex flex-col items-center gap-3 text-center">
									<div class="flex h-14 w-14 items-center justify-center rounded-full bg-cyan-900/60">
										<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" class="text-white/90">
											<path d="M4.5 11L12 4l7.5 7" />
											<path d="M6.5 10.5v9" />
											<path d="M17.5 10.5v9" />
											<path d="M6.5 19.5h11" />
											<path d="M10.5 19.5V14" />
											<path d="M13.5 19.5V14" />
										</svg>
									</div>
									<h2 class="text-xl font-semibold sm:text-2xl">¿Para qué necesitas el dinero?</h2>
									<p class="max-w-xs text-sm text-white/70 sm:text-base">Elige la opción que mejor se ajuste a tu objetivo.</p>
								</div>
								<div class="cotizador__options flex flex-col gap-4" role="list">
									<button class="cotizador__option group flex items-center gap-4 rounded-2xl border border-white/10 bg-white/5 px-5 py-4 text-left transition hover:-translate-y-1 hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400" type="button" role="listitem" data-category="home" aria-describedby="cotizador-home-help">
										<span class="cotizador__option-icon flex h-14 w-14 items-center justify-center rounded-full bg-cyan-900/60 text-white/90" aria-hidden="true">
											<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
												<path d="M4.5 11L12 4l7.5 7" />
												<path d="M6.5 10.5v8" />
												<path d="M17.5 10.5v8" />
												<path d="M6.5 18.5h11" />
												<path d="M10.5 18.5V14" />
												<path d="M13.5 18.5V14" />
											</svg>
										</span>
										<span class="cotizador__option-body flex flex-col gap-1">
											<h3 class="text-base font-semibold">Para comprar una casa</h3>
											<span id="cotizador-home-help" class="text-sm text-white/70">Te decimos cuánto pagarías al mes por tu nueva casa</span>
											<span class="cotizador__option-cta mt-2 inline-flex min-w-28 justify-center rounded-full bg-orange-400 px-4 py-1 text-xs font-semibold uppercase tracking-wide text-slate-900">Solicitar</span>
										</span>
									</button>
									<button class="cotizador__option group flex items-center gap-4 rounded-2xl border border-white/10 bg-white/5 px-5 py-4 text-left transition hover:-translate-y-1 hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400" type="button" role="listitem" data-category="business" aria-describedby="cotizador-business-help">
										<span class="cotizador__option-icon flex h-14 w-14 items-center justify-center rounded-full bg-cyan-900/60 text-white/90" aria-hidden="true">
											<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
												<rect x="4" y="9" width="16" height="10" rx="1.75" />
												<path d="M8.5 9V6.25A2.25 2.25 0 0 1 10.75 4h2.5A2.25 2.25 0 0 1 15.5 6.25V9" />
												<path d="M4 13.5h16" />
												<path d="M12 13.5v2.5" />
											</svg>
										</span>
										<span class="cotizador__option-body flex flex-col gap-1">
											<h3 class="text-base font-semibold">Para mi empresa</h3>
											<span id="cotizador-business-help" class="text-sm text-white/70">Quiero dinero para mi empresa</span>
											<span class="cotizador__option-cta mt-2 inline-flex min-w-28 justify-center rounded-full bg-orange-400 px-4 py-1 text-xs font-semibold uppercase tracking-wide text-slate-900">Solicitar</span>
										</span>
									</button>
									<button class="cotizador__option group flex items-center gap-4 rounded-2xl border border-white/10 bg-white/5 px-5 py-4 text-left transition hover:-translate-y-1 hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400" type="button" role="listitem" data-category="travel" aria-describedby="cotizador-travel-help">
										<span class="cotizador__option-icon flex h-14 w-14 items-center justify-center rounded-full bg-cyan-900/60 text-white/90" aria-hidden="true">
											<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
												<path d="M3.5 15.5l17-4.5-17-4.5 6 4.5-6 4.5" />
												<path d="M14 17v-6" />
												<path d="M10.5 8.25L13.5 12" />
												<path d="M10.5 15.75L13.5 12" />
											</svg>
										</span>
										<span class="cotizador__option-body flex flex-col gap-1">
											<h3 class="text-base font-semibold">Viaje, un evento u otra cosa</h3>
											<span id="cotizador-travel-help" class="text-sm text-white/70">Te prestamos para que viajes, celebres o disfrutes como mejor prefieras</span>
											<span class="cotizador__option-cta mt-2 inline-flex min-w-28 justify-center rounded-full bg-orange-400 px-4 py-1 text-xs font-semibold uppercase tracking-wide text-slate-900">Solicitar</span>
										</span>
									</button>
								</div>
							</section>

							<section class="cotizador__stage cotizador__stage--calculator flex flex-1 flex-col gap-6 overflow-y-auto pr-1 sm:pr-2" data-stage="calculator" aria-live="polite" hidden>
								<div class="cotizador__topbar flex items-center justify-between">
									<button class="cotizador__back inline-flex items-center gap-2 rounded-full border border-white/15 px-4 py-2 text-sm font-medium text-white transition hover:bg-white/10" type="button">
										<span aria-hidden="true">←</span>
										Regresar
									</button>
								</div>
								<div class="cotizador__summary flex flex-col items-center gap-3 text-center">
									<span class="cotizador__summary-icon flex h-16 w-16 items-center justify-center rounded-full bg-cyan-900/60" data-field="icon" aria-hidden="true"></span>
									<h3 class="text-xl font-semibold" data-field="title">Selecciona una opción</h3>
									<span class="text-sm text-white/70" data-field="subtitle">Elige un monto para comenzar.</span>
								</div>
								<div class="cotizador__field-group space-y-5">
									<div class="cotizador__field space-y-2">
										<label class="text-sm font-semibold" for="cotizador-amount" data-field="amount-label">Monto</label>
										<div class="cotizador__input-wrapper relative">
											<input
												class="cotizador__input w-full rounded-2xl border border-white/15 bg-white/10 px-4 py-3 pr-16 text-center text-lg font-semibold text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-orange-400"
												type="text"
												inputmode="numeric"
												id="cotizador-amount"
												name="amount"
												placeholder="$ 0.00"
												min="0"
												step="1000"
												autocomplete="off"
												required
											/>
											<span class="cotizador__unit pointer-events-none absolute inset-y-0 right-4 flex items-center text-xs font-bold uppercase tracking-wider text-white/70">MXN</span>
										</div>
										<div class="cotizador__feedback min-h-5 text-center text-sm text-white/70" data-role="range">Ingresa un monto para calcular.</div>
									</div>
									<div class="cotizador__field space-y-2" data-role="term-field">
										<label class="text-sm font-semibold" for="cotizador-term" data-field="term-label">Plazo en años</label>
										<select class="cotizador__select w-full rounded-2xl border border-white/15 bg-white/10 px-4 py-3 text-center text-sm font-semibold text-white focus:outline-none focus:ring-2 focus:ring-orange-400" id="cotizador-term" name="term"></select>
										<span class="cotizador__fixed-pill rounded-full border border-white/15 bg-white/10 px-4 py-2 text-center text-sm font-semibold" data-role="term-pill" hidden></span>
									</div>
									<div class="cotizador__feedback min-h-5 text-center text-sm" data-role="feedback"></div>
								</div>
								<div class="cotizador__loading text-center text-sm text-white/70" data-role="loading" hidden>Calculando...</div>
								<div class="cotizador__results space-y-4" data-role="results" hidden>
									<div class="cotizador__result-card rounded-2xl bg-white/10 p-4 text-center" data-result="principal">
										<span class="text-xs font-medium uppercase tracking-wider text-white/70" data-result-label>Un crédito de</span>
										<strong class="text-2xl font-semibold" data-result-value>$ 0</strong>
									</div>
									<div class="space-y-3" data-role="additional-results"></div>
								</div>
								<p class="cotizador__note rounded-2xl bg-white/5 px-5 py-4 text-center text-xs leading-relaxed text-white/70">
									Esta información es una aproximación general, sin embargo, al conocer tu caso particular seguramente te daremos una mejor oferta ya que trabajamos con los mejores bancos y encontraremos la mejor opción para ti.<br />
									Al continuar, aceptas nuestro
									<a class="font-semibold text-orange-300 hover:text-orange-200" href="https://creditaria.online/aviso-de-privacidad" target="_blank" rel="noreferrer">Aviso de Privacidad</a>.
								</p>
								<div class="cotizador__cta flex flex-col items-center gap-3">
									<a class="cotizador__cta-button inline-flex w-full max-w-[220px] justify-center rounded-full bg-orange-400 px-6 py-3 text-base font-semibold text-slate-900 shadow-lg transition hover:bg-orange-300" data-role="whatsapp" target="_blank" rel="noopener" href="https://wa.me/5219841055502">¿Platicamos?</a>
									<p class="cotizador__advisor text-xs uppercase tracking-[0.28em] text-white/60">Por ULISES PADILLA</p>
								</div>
							</section>
						</div>
					</div>
				</div>
			</main>
		</div>
		<footer class="bg-black/70 py-6 text-center text-sm text-white/60">
			<span>&copy; Creditaria</span>
		</footer>

		<script type="module">
			const categories = {
				home: {
					title: 'Para comprar una casa',
					subtitle: 'Te decimos cuánto pagarías al mes por tu nueva casa',
					amountLabel: 'Valor de la vivienda',
					termLabel: 'Plazo en años',
					min: 50000,
					max: 1000000,
					terms: [5, 10, 15, 20],
					icon: 'home'
				},
				business: {
					title: 'Para mi empresa',
					subtitle: 'Quiero dinero para mi empresa',
					amountLabel: '¿Cuánto dinero necesitas?',
					termLabel: 'En un plazo de',
					min: 10000,
					max: 1000000,
					terms: [3],
					icon: 'briefcase'
				},
				travel: {
					title: 'Viaje, un evento u otra cosa',
					subtitle: 'Te prestamos para que viajes, celebres o disfrutes como mejor prefieras',
					amountLabel: '¿Cuánto dinero necesitas?',
					termLabel: 'En un plazo de',
					min: 10000,
					max: 1000000,
					terms: [15],
					icon: 'plane'
				}
			};

			const iconTemplates = {
				home: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 11L12 4l7.5 7" /><path d="M6.5 10.5v8" /><path d="M17.5 10.5v8" /><path d="M6.5 18.5h11" /><path d="M10.5 18.5V14" /><path d="M13.5 18.5V14" /></svg>',
				briefcase: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="9" width="16" height="10" rx="1.75" /><path d="M8.5 9V6.25A2.25 2.25 0 0 1 10.75 4h2.5A2.25 2.25 0 0 1 15.5 6.25V9" /><path d="M4 13.5h16" /><path d="M12 13.5v2.5" /></svg>',
				plane: '<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3.5 15.5l17-4.5-17-4.5 6 4.5-6 4.5" /><path d="M14 17v-6" /><path d="M10.5 8.25L13.5 12" /><path d="M10.5 15.75L13.5 12" /></svg>'
			};

			const formatCurrency = (value) =>
				new Intl.NumberFormat('es-MX', {
					style: 'currency',
					currency: 'MXN',
					maximumFractionDigits: 0
				}).format(Number(value) || 0);

			const sanitizeAmount = (raw) => raw.replace(/[^0-9]/g, '');

			document.addEventListener('DOMContentLoaded', () => {
				const cotizador = document.querySelector('.cotizador');
				const selectStage = cotizador ? cotizador.querySelector('[data-stage="select"]') : null;
				const calculatorStage = cotizador ? cotizador.querySelector('[data-stage="calculator"]') : null;
				const optionButtons = Array.from(document.querySelectorAll('.cotizador__option'));
				const backButton = cotizador ? cotizador.querySelector('.cotizador__back') : null;
				const resultsContainer = cotizador ? cotizador.querySelector('[data-role="results"]') : null;
				const additionalResultsContainer = cotizador ? cotizador.querySelector('[data-role="additional-results"]') : null;
				const loadingLabel = cotizador ? cotizador.querySelector('[data-role="loading"]') : null;
				const amountInput = cotizador ? cotizador.querySelector('#cotizador-amount') : null;
				const termSelect = cotizador ? cotizador.querySelector('#cotizador-term') : null;
				const termPill = cotizador ? cotizador.querySelector('[data-role="term-pill"]') : null;
				const feedback = cotizador ? cotizador.querySelector('[data-role="feedback"]') : null;
				const rangeHint = cotizador ? cotizador.querySelector('[data-role="range"]') : null;
				const titleNode = cotizador ? cotizador.querySelector('[data-field="title"]') : null;
				const subtitleNode = cotizador ? cotizador.querySelector('[data-field="subtitle"]') : null;
				const amountLabelNode = cotizador ? cotizador.querySelector('[data-field="amount-label"]') : null;
				const termLabelNode = cotizador ? cotizador.querySelector('[data-field="term-label"]') : null;
				const principalCard = cotizador ? cotizador.querySelector('[data-result="principal"]') : null;
				const summaryIcon = cotizador ? cotizador.querySelector('[data-field="icon"]') : null;
				const whatsappLink = cotizador ? cotizador.querySelector('[data-role="whatsapp"]') : null;

				if (
					!(cotizador instanceof HTMLElement) ||
					!(selectStage instanceof HTMLElement) ||
					!(calculatorStage instanceof HTMLElement) ||
					optionButtons.length === 0 ||
					!(backButton instanceof HTMLButtonElement) ||
					!(resultsContainer instanceof HTMLElement) ||
					!(additionalResultsContainer instanceof HTMLElement) ||
					!(loadingLabel instanceof HTMLElement) ||
					!(amountInput instanceof HTMLInputElement) ||
					!(termSelect instanceof HTMLSelectElement) ||
					!(termPill instanceof HTMLElement) ||
					!(feedback instanceof HTMLElement) ||
					!(rangeHint instanceof HTMLElement) ||
					!(titleNode instanceof HTMLElement) ||
					!(subtitleNode instanceof HTMLElement) ||
					!(amountLabelNode instanceof HTMLElement) ||
					!(termLabelNode instanceof HTMLElement) ||
					!(principalCard instanceof HTMLElement) ||
					!(summaryIcon instanceof HTMLElement) ||
					!(whatsappLink instanceof HTMLAnchorElement)
				) {
					console.warn('No se pudo inicializar el cotizador: faltan elementos.');
					return;
				}

				const whatsappBaseUrl = whatsappLink.href.split('?')[0];
				const defaultState = {
					title: titleNode.textContent || '',
					subtitle: subtitleNode.textContent || '',
					amountLabel: amountLabelNode.textContent || '',
					termLabel: termLabelNode.textContent || '',
					rangeHint: rangeHint.textContent || '',
					icon: summaryIcon.innerHTML,
					whatsappHref: whatsappBaseUrl
				};

				let activeCategory = null;
				let debounceTimer = null;

				const toggleHidden = (element, shouldHide) => {
					if (!element) return;
					element.hidden = shouldHide;
					element.classList.toggle('hidden', shouldHide);
					if (shouldHide) {
						element.setAttribute('aria-hidden', 'true');
					} else {
						element.removeAttribute('aria-hidden');
					}
				};

				const resetResults = () => {
					resultsContainer.hidden = true;
					const principalValueNode = principalCard.querySelector('[data-result-value]');
					if (principalValueNode) {
						principalValueNode.textContent = '$ 0';
					}
					additionalResultsContainer.innerHTML = '';
				};

				const setView = (view) => {
					cotizador.dataset.view = view;
					toggleHidden(selectStage, view !== 'select');
					toggleHidden(calculatorStage, view !== 'calculator');
				};

				const populateTerms = (category) => {
					termSelect.innerHTML = '';
					category.terms.forEach((term) => {
						const option = document.createElement('option');
						option.value = String(term);
						option.textContent = `${term} años`;
						termSelect.append(option);
					});

					const singleTerm = category.terms.length === 1;
					termSelect.value = String(category.terms[0]);
					termSelect.disabled = singleTerm;
					toggleHidden(termSelect, singleTerm);
					termPill.textContent = singleTerm ? `${category.terms[0]} años` : '';
					toggleHidden(termPill, !singleTerm);
				};

				const updateWhatsAppLink = (amount) => {
					if (typeof amount !== 'number' || Number.isNaN(amount) || amount <= 0) {
						whatsappLink.href = defaultState.whatsappHref;
						return;
					}

					const formatted = formatCurrency(amount);
					const message = encodeURIComponent(`Hola, me gustaría saber más sobre el crédito. Busco ${formatted}.`);
					whatsappLink.href = `${defaultState.whatsappHref}?text=${message}`;
				};

				const validateAmount = (category, value) => {
					const numeric = Number(value);

					if (value === '') {
						delete feedback.dataset.state;
						feedback.textContent = '';
						rangeHint.textContent = category.min > 0
							? `Ingresa un monto entre ${formatCurrency(category.min)} y ${formatCurrency(category.max)}.`
							: `Ingresa un monto hasta ${formatCurrency(category.max)}.`;
						return null;
					}

					if (Number.isNaN(numeric)) {
						delete feedback.dataset.state;
						feedback.textContent = '';
						return null;
					}

					if (numeric < category.min) {
						feedback.dataset.state = 'error';
						feedback.textContent = category.min > 0
							? `El monto mínimo es ${formatCurrency(category.min)}.`
							: 'Ingresa un monto mayor a 0.';
						return null;
					}

					if (numeric > category.max) {
						feedback.dataset.state = 'error';
						feedback.textContent = `El monto máximo permitido es ${formatCurrency(category.max)}.`;
						return null;
					}

					delete feedback.dataset.state;
					feedback.textContent = '';
					rangeHint.textContent = category.min > 0
						? `Ingresa un monto entre ${formatCurrency(category.min)} y ${formatCurrency(category.max)}.`
						: `Ingresa un monto hasta ${formatCurrency(category.max)}.`;

					return numeric;
				};

				const renderResults = (data) => {
					const payload = data && typeof data === 'object' ? data : {};
					const principalData =
						payload && typeof payload === 'object' && payload.formula_principal && typeof payload.formula_principal === 'object'
							? payload.formula_principal
							: {};

					const principalLabelNode = principalCard.querySelector('[data-result-label]');
					const principalValueNode = principalCard.querySelector('[data-result-value]');

					const principalLabel = typeof principalData.label === 'string' ? principalData.label : 'Un crédito de';
					const principalValue = Number(principalData.value) || 0;

					if (principalLabelNode) {
						principalLabelNode.textContent = principalLabel;
					}

					if (principalValueNode) {
						principalValueNode.textContent = formatCurrency(principalValue);
					}

					additionalResultsContainer.innerHTML = '';
					const additionalRaw = payload && typeof payload === 'object' ? payload.resultados_individuales : null;
					const additional = Array.isArray(additionalRaw) ? additionalRaw : [];

					additional.forEach((item, index) => {
						if (!item || typeof item !== 'object') {
							return;
						}

						const wrapper = document.createElement('div');
						wrapper.className = 'cotizador__result-card rounded-2xl bg-white/10 p-4 text-center';
						wrapper.dataset.resultItem = String(index);

						const labelNode = document.createElement('span');
						labelNode.dataset.resultLabel = '';
						labelNode.className = 'text-xs font-medium uppercase tracking-wider text-white/70';
						labelNode.textContent = typeof item.label === 'string' ? item.label : '';

						const valueNode = document.createElement('strong');
						valueNode.dataset.resultValue = '';
						valueNode.className = 'text-xl font-semibold';
						valueNode.textContent = formatCurrency(Number(item.value) || 0);

						wrapper.append(labelNode, valueNode);
						additionalResultsContainer.append(wrapper);
					});

					resultsContainer.hidden = false;
					delete feedback.dataset.state;
					feedback.textContent = '';
				};

				const fetchResults = async (amount) => {
					loadingLabel.hidden = false;
					resultsContainer.hidden = true;

					try {
						const response = await fetch('https://creditaria.online/api/producto_calculo/calcular', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								producto_id: 2,
								user_id: 6918,
								valores_api: {
									expected_revenue: String(amount)
								}
							})
						});

						if (!response.ok) {
							throw new Error('Error al obtener resultados');
						}

						const payload = await response.json();
						const result =
							payload && typeof payload === 'object' && 'result' in payload ? payload.result : payload;

						renderResults(result);
					} catch (error) {
						console.error(error);
						feedback.dataset.state = 'error';
						feedback.textContent = 'Ocurrió un error al calcular. Intenta nuevamente.';
					} finally {
						loadingLabel.hidden = true;
					}
				};

				const handleAmountChange = (rawValue) => {
					if (!activeCategory) {
						return;
					}

					const raw = typeof rawValue === 'string' ? rawValue : sanitizeAmount(amountInput.value);
					const validAmount = validateAmount(activeCategory, raw);

					if (validAmount === null) {
						updateWhatsAppLink();
						resultsContainer.hidden = true;
						return;
					}

					updateWhatsAppLink(validAmount);

					if (debounceTimer) {
						clearTimeout(debounceTimer);
					}

					debounceTimer = setTimeout(() => {
						fetchResults(validAmount);
					}, 400);
				};

				const handleAmountInput = () => {
					const raw = sanitizeAmount(amountInput.value);

					if (raw === '') {
						amountInput.value = '';
						handleAmountChange('');
						return;
					}

					const numeric = Number(raw);
					amountInput.value = formatCurrency(numeric);
					handleAmountChange(raw);
				};

				const handleOptionSelect = (categoryKey) => {
					const category = categories[categoryKey];
					if (!category) {
						return;
					}

					activeCategory = category;
					optionButtons.forEach((button) => {
						button.classList.toggle('is-active', button.dataset.category === categoryKey);
					});

					titleNode.textContent = category.title;
					subtitleNode.textContent = category.subtitle;
					amountLabelNode.textContent = category.amountLabel;
					termLabelNode.textContent = category.termLabel;
					rangeHint.textContent = category.min > 0
						? `Ingresa un monto entre ${formatCurrency(category.min)} y ${formatCurrency(category.max)}.`
						: `Ingresa un monto hasta ${formatCurrency(category.max)}.`;

					amountInput.value = '';
					delete feedback.dataset.state;
					feedback.textContent = '';

					populateTerms(category);
					resetResults();
					summaryIcon.innerHTML = iconTemplates[category.icon] || defaultState.icon;
					setView('calculator');

					requestAnimationFrame(() => {
						amountInput.focus({ preventScroll: true });
					});
				};

				optionButtons.forEach((button) => {
					button.addEventListener('click', () => {
						const key = button.dataset.category;
						if (!key || !(key in categories)) {
							return;
						}

						handleOptionSelect(key);
					});
				});

				backButton.addEventListener('click', () => {
					setView('select');
					optionButtons.forEach((button) => button.classList.remove('is-active'));
					activeCategory = null;

					titleNode.textContent = defaultState.title;
					subtitleNode.textContent = defaultState.subtitle;
					amountLabelNode.textContent = defaultState.amountLabel;
					termLabelNode.textContent = defaultState.termLabel;
					rangeHint.textContent = defaultState.rangeHint;
					summaryIcon.innerHTML = defaultState.icon;

					amountInput.value = '';
					delete feedback.dataset.state;
					feedback.textContent = '';

					termSelect.disabled = false;
					toggleHidden(termSelect, false);
					termSelect.innerHTML = '';
					termPill.textContent = '';
					toggleHidden(termPill, true);

					resetResults();
					updateWhatsAppLink();
					loadingLabel.hidden = true;
				});

				amountInput.addEventListener('input', handleAmountInput);

				setView('select');
				resetResults();
				updateWhatsAppLink();
				loadingLabel.hidden = true;
			});
		</script>
	</body>
</html>
